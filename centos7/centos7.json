{
  "_copyright": "2016-2021, Frederico Martins",
  "_author":    "Frederico Martins <http://github.com/fscm>",
  "_license":   "SPDX-License-Identifier: MIT",
  "variables": {
    "checksum_type":    "none",
    "checksum_value":   "",
    "headless":         "true",
    "os_arch":          "x86_64",
    "os_codename":      "centos",
    "os_version":       "7",
    "os_version_build": "1804",
    "os_short_arch":    "64",
    "os_type":          "RedHat_64",
    "os_type_alt":      "centos",
    "system_disk_size": "8192",
    "system_domain":    "marsh",
    "system_hostname":  "centos",
    "system_locale":    "en_US",
    "system_memory":    "384",
    "system_pwd":       "centos",
    "system_timezone":  "UTC",
    "system_user":      "pollywog"
  },
  "builders": [
    {
      "name":                   "parallels",
      "type":                   "parallels-iso",
      "boot_wait":              "10s",
      "disk_size":              "{{user `system_disk_size`}}",
      "guest_os_type":          "{{user `os_type_alt`}}",
      "hard_drive_interface":   "sata",
      "http_directory":         "http",
      "iso_checksum":           "{{user `checksum_value`}}",
      "iso_checksum_type":      "{{user `checksum_type`}}",
      "iso_target_path":        "../builds/cache/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
      "output_directory":       "../builds/sandbox/{{build_type}}",
      "parallels_tools_mode":   "upload",
      "parallels_tools_flavor": "lin",
      "ssh_username":           "root",
      "ssh_password":           "{{user `system_pwd`}}",
      "ssh_port":               22,
      "ssh_wait_timeout":       "3600s",
      "shutdown_command":       "echo '{{user `system_pwd`}}' | sudo -S /sbin/shutdown -hP now",
      "vm_name":                "{{user `os_codename`}}{{user `os_short_arch`}}-{{isotime \"20060102150405\"}}",
      "boot_command": [
        "<tab> ",
        "text ",
        "inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/kickstart.cfg ",
        "inst.kdump_addon=off ",
        "inst.nosave=all<enter>"
      ],
      "iso_urls": [
        "../builds/isos/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://buildlogs.centos.org/rolling/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://isoredirect.centos.org/centos/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso"
      ],
      "prlctl": [
        ["set", "{{.Name}}", "--3d-accelerate", "off"],
        ["set", "{{.Name}}", "--adaptive-hypervisor", "on"],
        ["set", "{{.Name}}", "--auto-share-camera", "off"],
        ["set", "{{.Name}}", "--auto-share-bluetooth", "off"],
        ["set", "{{.Name}}", "--autostart", "off"],
        ["set", "{{.Name}}", "--autostop", "stop"],
        ["set", "{{.Name}}", "--cpus", "1"],
        ["set", "{{.Name}}", "--device-bootorder", "hdd0 cdrom0"],
        ["set", "{{.Name}}", "--device-del", "sound0"],
        ["set", "{{.Name}}", "--device-set", "net0", "--adapter-type", "e1000"],
        ["set", "{{.Name}}", "--efi-boot", "off"],
        ["set", "{{.Name}}", "--faster-vm", "off"],
        ["set", "{{.Name}}", "--high-resolution", "off"],
        ["set", "{{.Name}}", "--memsize", "{{user `system_memory`}}"],
        ["set", "{{.Name}}", "--nested-virt", "on"],
        ["set", "{{.Name}}", "--on-window-close", "keep-running"],
        ["set", "{{.Name}}", "--sync-host-printers", "off"],
        ["set", "{{.Name}}", "--tools-autoupdate", "off"],
        ["set", "{{.Name}}", "--videosize", "12"]
      ]
    },
    {
      "name":                 "virtualbox",
      "type":                 "virtualbox-iso",
      "boot_wait":            "10s",
      "disk_size":            "{{user `system_disk_size`}}",
      "guest_additions_mode": "upload",
      "guest_additions_path": "VBoxGuestAdditions.iso",
      "guest_os_type":        "{{user `os_type`}}",
      "hard_drive_interface": "sata",
      "headless":             "{{user `headless`}}",
      "http_directory":       "http",
      "iso_checksum":         "{{user `checksum_value`}}",
      "iso_checksum_type":    "{{user `checksum_type`}}",
      "iso_target_path":      "../builds/cache/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
      "output_directory":     "../builds/sandbox/{{build_type}}",
      "shutdown_command":     "echo '{{user `system_pwd`}}' | sudo -S /sbin/shutdown -hP now",
      "ssh_username":         "root",
      "ssh_password":         "{{user `system_pwd`}}",
      "ssh_port":             22,
      "ssh_wait_timeout":     "3600s",
      "vm_name":              "{{user `os_codename`}}{{user `os_short_arch`}}-{{isotime \"20060102150405\"}}",
      "boot_command": [
        "<tab> ",
        "text ",
        "inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/kickstart.cfg ",
        "inst.kdump_addon=off ",
        "inst.nosave=all<enter>"
      ],
      "iso_urls": [
        "../builds/isos/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://buildlogs.centos.org/rolling/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://isoredirect.centos.org/centos/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso"
      ],
      "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--memory", "{{user `system_memory`}}"],
        ["modifyvm", "{{.Name}}", "--vram", "12"],
        ["modifyvm", "{{.Name}}", "--pae", "off"],
        ["modifyvm", "{{.Name}}", "--cpus", "1"],
        ["modifyvm", "{{.Name}}", "--hwvirtex", "on"],
        ["modifyvm", "{{.Name}}", "--paravirtprovider", "legacy"],
        ["modifyvm", "{{.Name}}", "--nestedpaging", "on"],
        ["modifyvm", "{{.Name}}", "--accelerate3d", "off"],
        ["modifyvm", "{{.Name}}", "--accelerate2dvideo", "off"],
        ["modifyvm", "{{.Name}}", "--chipset", "piix3"],
        ["modifyvm", "{{.Name}}", "--boot1", "dvd"],
        ["modifyvm", "{{.Name}}", "--boot2", "disk"],
        ["modifyvm", "{{.Name}}", "--boot3", "none"],
        ["modifyvm", "{{.Name}}", "--boot4", "none"],
        ["modifyvm", "{{.Name}}", "--mouse", "ps2"],
        ["modifyvm", "{{.Name}}", "--keyboard", "ps2"],
        ["modifyvm", "{{.Name}}", "--audio", "none"],
        ["modifyvm", "{{.Name}}", "--usb", "off"],
        ["modifyvm", "{{.Name}}", "--vrde", "off"]
      ]
    },
    {
      "name":                           "vmware",
      "type":                           "vmware-iso",
      "boot_wait":                      "10s",
      "disk_size":                      "{{user `system_disk_size`}}",
      "disk_type_id":                   "0",
      "guest_os_type":                  "{{user `os_type_alt`}}-{{user `os_short_arch`}}",
      "headless":                       "{{user `headless`}}",
      "http_directory":                 "http",
      "iso_checksum":                   "{{user `checksum_value`}}",
      "iso_checksum_type":              "{{user `checksum_type`}}",
      "iso_target_path":                "../builds/cache/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
      "output_directory":               "../builds/sandbox/{{build_type}}",
      "shutdown_command":               "echo '{{user `system_pwd`}}' | sudo -S /sbin/shutdown -hP now",
      "ssh_username":                   "root",
      "ssh_password":                   "{{user `system_pwd`}}",
      "ssh_port":                       22,
      "ssh_wait_timeout":               "3600s",
      "vm_name":                        "{{user `os_codename`}}{{user `os_short_arch`}}-{{isotime \"20060102150405\"}}",
      "vmdk_name":                      "{{user `os_codename`}}{{user `os_short_arch`}}-{{isotime \"20060102150405\"}}",
      "vmx_remove_ethernet_interfaces": "true",
      "boot_command": [
        "<tab> ",
        "text ",
        "inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/kickstart.cfg ",
        "inst.kdump_addon=off ",
        "inst.nosave=all<enter>"
      ],
      "iso_urls": [
        "../builds/isos/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://buildlogs.centos.org/rolling/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso",
        "http://isoredirect.centos.org/centos/{{user `os_version`}}/isos/{{user `os_arch`}}/CentOS-{{user `os_version`}}-{{user `os_arch`}}-NetInstall-{{user `os_version_build`}}.iso"
      ],
      "vmx_data": {
        "cpuid.coresPerSocket":     "1",
        "ehci.present":             "FALSE",
        "ethernet0.connectionType": "nat",
        "ethernet0.virtualDev":     "e1000",
        "floppy0.present":          "FALSE",
        "hpet0.present":            "TRUE",
        "memsize":                  "{{user `system_memory`}}",
        "numvcpus":                 "1",
        "serial0.present":          "FALSE",
        "sound.present":            "FALSE",
        "usb.present":              "FALSE",
        "vhv.enable":               "TRUE",
        "virtualHW.version":        "10"
      }
    }
  ],
  "provisioners": [
    {
      "only":           ["parallels"],
      "type":           "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "echo === System Packages ===",
        "yum -y install gcc kernel-devel kernel-headers dkms make bzip2",
        "yum -y erase linux-firmware",
        "mkdir -p /media/parallels_tools_cd",
        "mount -r prl-tools-lin.iso /media/parallels_tools_cd",
        "/media/parallels_tools_cd/install --install-unattended-with-deps --progress",
        "umount /media/parallels_tools_cd",
        "rm -rf /media/parallels_tools_cd",
        "rm -rf /etc/kernel/prerm.d/*",
        "yum clean all"
      ]
    },
    {
      "only":           ["virtualbox"],
      "type":           "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "echo === System Packages ===",
        "yum -y install gcc kernel-devel kernel-headers dkms make bzip2",
        "yum -y erase linux-firmware",
        "mkdir -p /media/guest_additions_cd",
        "mount -r VBoxGuestAdditions.iso /media/guest_additions_cd",
        "/media/guest_additions_cd/VBoxLinuxAdditions.run --nox11",
        "umount /media/guest_additions_cd",
        "rm -rf /media/guest_additions_cd",
        "yum clean all"
      ]
    },
    {
      "only":           ["vmware"],
      "type":           "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "echo === System Packages ===",
        "yum -y install open-vm-tools bzip2",
        "yum -y erase linux-firmware",
        "yum clean all"
      ]
    },
    {
      "type":           "shell",
      "inline_shebang": "/bin/bash -e",
      "inline": [
        "unset HISTFILE",
        "history -cw",
        "echo === System Settings ===",
        "sed -i -e '/^#NAutoVTs/aNAutoVTs=2' /etc/systemd/logind.conf",
        "echo {{user `system_hostname`}}.{{user `system_domain`}} > /etc/hostname",
        "sed -i -e 's/^search .*/search {{user `system_domain`}}/' /etc/resolv.conf",
        "echo 'export TZ=:/etc/localtime' | sudo tee /etc/profile.d/tz.sh > /dev/null",
        "echo === Extra System Settings ===",
        "sed -r -i -e '/ext4/s|UUID=[^ ]* (.*)|LABEL=/     \\1|' /etc/fstab",
        "sed -r -i -e '/swap/s|UUID=[^ ]* (.*)|LABEL=SWAP  \\1|' /etc/fstab",
        "sed -r -i -e '/GRUB_TIMEOUT=/s/=.*/=1/' /etc/default/grub",
        "grub2-mkconfig --output=/boot/grub2/grub.cfg",
        "echo 'blacklist pcspkr' > /etc/modprobe.d/pcspkr-blacklist.conf",
        "echo 'blacklist intel_rapl' > /etc/modprobe.d/rapl-blacklist.conf",
        "echo 'blacklist i2c_piix4' > /etc/modprobe.d/piix4-blacklist.conf",
        "dracut --force",
        "sed -i -r -e '/UseDNS /{h;s/#*UseDNS.*/UseDNS no/};${x;/^$/{s//\\nUseDNS no/;H};x}' /etc/ssh/sshd_config",
        "sed -i -r -e '/GSSAPIAuthentication /{h;s/#*GSSAPIAuthentication.*/GSSAPIAuthentication no/};${x;/^$/{s//\\nGSSAPIAuthentication no/;H};x}' /etc/ssh/sshd_config",
        "echo === System Users ===",
        "echo root:{{user `system_pwd`}} | chpasswd",
        "useradd -m -c '{{user `system_user`}}' -s /bin/bash -d /home/{{user `system_user`}} {{user `system_user`}}",
        "usermod -a -G {{user `system_user`}} {{user `system_user`}}",
        "echo {{user `system_user`}}:{{user `system_pwd`}} | chpasswd",
        "for user in /home/*; do echo \"${user##*/}  ALL=(ALL) NOPASSWD: ALL\" > /etc/sudoers.d/${user##*/}; done",
        "echo === Shared Folder ===",
        "mkdir /shared",
        "chown {{user `system_user`}}:{{user `system_user`}} /shared",
        "echo === SSH Key ===",
        "mkdir -p /home/{{user `system_user`}}/.ssh",
        "curl -sL --retry 3 --insecure 'https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub' -o /home/{{user `system_user`}}/.ssh/authorized_keys",
        "chmod 0700 /home/{{user `system_user`}}/.ssh",
        "chmod 0600 /home/{{user `system_user`}}/.ssh/authorized_keys",
        "chown -R {{user `system_user`}}:{{user `system_user`}} /home/{{user `system_user`}}/.ssh",
        "echo === System Cleanup ===",
        "rm -f /root/.bash_history",
        "rm -f /root/.vbox_version",
        "rm -f /root/.prlctl_version",
        "rm -f /root/*.iso",
        "rm -f /home/{{user `system_user`}}/.bash_history",
        "rm -f /home/{{user `system_user`}}/.vbox_version",
        "rm -f /home/{{user `system_user`}}/.prlctl_version",
        "rm -f /home/{{user `system_user`}}/*.iso",
        "rm -f /var/log/wtmp",
        "rm -f /var/log/btmp",
        "rm -f /var/log/VBoxGuestAdditions.log",
        "rm -f /var/log/vboxadd-install*",
        "rm -rf /var/log/installer",
        "rm -rf /tmp/* /var/tmp/* /tmp/.*-unix",
        "\\cp -f /usr/lib/locale/locale-archive /usr/lib/locale/locale-archive.tmpl",
        "build-locale-archive --install-langs=\"en:pt\"",
        "find /usr/share/locale/* -maxdepth 0 -type d -not -name 'pt*' -not -name 'en*' -exec rm -rf {} \\;",
        "find /usr/share/doc/* -maxdepth 0 -not -name 'virtualbox*' -exec rm -rf {} \\;",
        "find /var/cache -type f -delete",
        "find /var/log -type f | while read f; do echo -n '' | sudo tee $f > /dev/null; done;",
        "SWAP_PARTITION=$(blkid -L SWAP)",
        "swapoff ${SWAP_PARTITION}",
        "dd if=/dev/zero of=${SWAP_PARTITION} || echo 'dd exit code suppressed'",
        "mkswap -L SWAP ${SWAP_PARTITION}",
        "swapon ${SWAP_PARTITION}",
        "dd if=/dev/zero of=/EMPTY bs=1M || echo 'dd exit code suppressed'",
        "rm -f /EMPTY",
        "sync",
        "echo === System Info ===",
        "#df -h /",
        "du -sh / --exclude=/proc",
        "echo '--------------------------------------------------'",
        "echo -n '  ' ; cat /etc/centos-release",
        "echo '-------------------------------------------------'",
        "echo === All Done ==="
      ]
    },
    {
      "type":    "shell-local",
      "command": "case \"$OSTYPE\" in *linux*|*hurd*|*msys*|*cygwin*|*sua*|*interix*) sed -i'' -e '/config.ssh.username/s/=.*/= \"{{user `system_user`}}\"/' Vagrantfile.tpl;; *) sed -i '' -e '/config.ssh.username/s/=.*/= \"{{user `system_user`}}\"/' Vagrantfile.tpl;; esac"
    }
  ],
  "post-processors": [
    [
      {
        "type":                 "vagrant",
        "compression_level":    9,
        "keep_input_artifact":  false,
        "vagrantfile_template": "Vagrantfile.tpl",
        "output":               "../builds/providers/{{ .Provider }}/{{user `os_codename`}}{{user `os_short_arch`}}.box"
      }
    ]
  ]
}
